<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math & Music Visualizer</title>
    <link rel="stylesheet" href="style.css?v=86">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <canvas id="visualizer"></canvas>

    <div class="controls">
        <header>
            <h1>Sonic Geometry</h1>
            <p>Math x Buffer</p>
        </header>

        <div class="control-group">
            <button id="toggle-audio" class="btn-primary">Start Audio</button>
        </div>

        <!-- MODE SELECTOR -->
        <div class="control-group mode-selector">
            <label>Mode</label>
            <div class="mode-buttons">
                <button class="mode-btn active" data-mode="theory" title="Learn scales, chords, and theory">üéì
                    Theory</button>
                <button class="mode-btn" data-mode="practice" title="Interactive exercises and drills">üéØ
                    Practice</button>
                <button class="mode-btn" data-mode="production" title="Create with intelligent suggestions">üéπ
                    Produce</button>
            </div>
        </div>

        <!-- KEY/SCALE SELECTOR (visible in all modes) -->
        <div class="control-group" id="key-controls">
            <label>Key / Scale</label>
            <div class="key-row">
                <select id="key-root" title="Root note of the key">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A" selected>A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
                <select id="scale-type" title="Scale type">
                    <option value="naturalMinor" selected>Minor</option>
                    <option value="major">Major</option>
                    <option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="harmonicMinor">Harmonic Minor</option>
                    <option value="melodicMinor">Melodic Minor</option>
                    <option value="majorPentatonic">Major Pentatonic</option>
                    <option value="minorPentatonic">Minor Pentatonic</option>
                    <option value="blues">Blues</option>
                </select>
            </div>
            <div id="scale-notes" class="scale-display">A B C D E F G</div>
        </div>

        <!-- DIATONIC CHORDS (Theory/Production modes) -->
        <div class="control-group" id="diatonic-panel">
            <label>Chords in Key <span class="info-icon"
                    title="These chords naturally fit the selected scale">‚ìò</span></label>
            <div id="diatonic-chords" class="chord-grid">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- KEY DETECTION (Production mode) -->
        <div class="control-group hidden" id="key-detection-panel">
            <label>Detected Key</label>
            <div id="detected-key" class="detected-key-display">Play some notes...</div>
        </div>

        <div class="control-group">
            <label>Visualization</label>
            <select id="viz-mode">
                <option value="oscilloscope">Waveform</option>
                <option value="spectrum">Spectrum</option>
                <option value="lissajous">Lissajous</option>
                <option value="interference">Interference Pattern</option>
            </select>
            <button id="btn-ear-gym" class="btn-secondary" style="margin-top: 5px;">üëÇ Ear Gym</button>
            <div id="midi-status" class="hidden" style="margin-top: 10px; font-size: 0.8rem; opacity: 0.8;">üéπ MIDI
                Ready</div>
        </div>

        <div class="control-group">
            <label for="osc-type">Waveform</label>
            <select id="osc-type">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="sawtooth">Sawtooth</option>
                <option value="triangle">Triangle</option>
            </select>
        </div>

        <div class="control-group">
            <label for="freq-control">Frequency: <span id="freq-val">440</span> Hz</label>
            <input type="range" id="freq-control" min="55" max="880" value="440" step="1">
        </div>

        <div class="control-group" id="detune-group" style="display: none;">
            <label for="detune-control">L/R Detune: <span id="detune-val">0</span> cents</label>
            <input type="range" id="detune-control" min="0" max="100" value="5" step="1">
            <small>Needed for Lissajous figures</small>
        </div>

        <!-- Harmony Controls -->
        <div class="control-group" id="harmony-group" style="display: none;">
            <label>Interval Ratio</label>
            <div class="radio-group">
                <label><input type="radio" name="ratio" value="1" checked> Unison (1:1)</label>
                <label><input type="radio" name="ratio" value="2"> Octave (2:1)</label>
                <label><input type="radio" name="ratio" value="1.5"> Perfect 5th (3:2)</label>
                <label><input type="radio" name="ratio" value="1.25"> Major 3rd (5:4)</label>
                <label><input type="radio" name="ratio" value="1.0666"> Dissonant (16:15)</label>
            </div>
        </div>

        <!-- Circle Controls -->
        <div class="control-group" id="circle-group" style="display: none;">
            <label>Circle of Fifths</label>
            <div class="button-group">
                <button id="btn-prev-fifth" class="btn-primary">‚Üê Prev</button>
                <button id="btn-next-fifth" class="btn-primary">Next ‚Üí</button>
            </div>
            <div id="hover-info" class="hover-tooltip">Hover over controls...</div>
            <button id="btn-reset-circle" class="btn-secondary">Reset to C (Start)</button>
            <div class="stats">
                <p>Steps: <span id="circle-steps">0</span></p>
                <p>Calculated Freq: <span id="circle-freq">100.00</span> Hz</p>
                <p>Pythagorean Error: <span id="circle-error">0</span> cents</p>
            </div>
        </div>

        <!-- Lessons Controls -->
        <div class="control-group">
            <label>Guided Lessons</label>
            <button class="btn-secondary" onclick="lessonManager.startLesson(0)">1. Physics of Sound</button>
            <button class="btn-secondary" onclick="lessonManager.startLesson(1)">2. Harmonics</button>
        </div>

        <!-- Educational Info Panel -->
        <div id="edu-panel" class="edu-panel hidden">
            <h3 id="edu-title">Concept Title</h3>
            <p id="edu-desc">Description goes here.</p>
            <p id="edu-math" class="math-note">Math: Ratio or Formula</p>
        </div>
    </div>

    <!-- Harmony Analysis Badge (Moved outside for CSS/JS stability) -->
    <div id="analysis-panel" class="analysis-badge" style="display: none;">
        <h3 id="chord-name">C Major</h3>
        <div class="analysis-details">
            <span id="chord-ratios">1 : 1.25 : 1.5</span>
            <span id="chord-stability" class="tag-consonant">Consonant</span>
        </div>
    </div>

    <!-- Keyboard Legend -->
    <div id="keyboard-legend" class="keyboard-legend">
        <span class="legend-item">
            <span class="legend-swatch root-swatch"></span>
            Root Note
        </span>
        <span class="legend-item">
            <span class="legend-swatch in-scale-swatch"></span>
            In Scale
        </span>
        <span class="legend-item">
            <span class="legend-swatch out-scale-swatch"></span>
            Out of Scale
        </span>
        <span class="legend-info" title="Notes in scale will sound 'correct'. The root is your 'home' note.">üí° Play
            only bright keys to stay in key!</span>
    </div>

    <div id="keyboard-container" class="keyboard">
        <!-- Keys injected by JS -->
    </div>

    <!-- EAR TRAINING OVERLAY -->
    <div id="ear-trainer" class="ear-overlay hidden">
        <div class="ear-box">
            <div class="ear-header">
                <h2>üëÇ Ear Gym</h2>
                <button id="close-ear" class="btn-icon">√ó</button>
            </div>

            <!-- Level Select -->
            <div id="ear-levels" class="ear-levels">
                <button class="btn-level" onclick="earTrainer.startLevel(1)">Level 1: Stability</button>
                <button class="btn-level" onclick="earTrainer.startLevel(2)">Level 2: Ratios</button>
                <button class="btn-level" onclick="earTrainer.startLevel(3)">Level 3: Perfect Pitch</button>
            </div>

            <!-- Game Mode -->
            <div id="ear-game" class="hidden">
                <div class="ear-status">
                    <span id="level-title">Level 1</span>
                    <span id="ear-score">Score: 0</span>
                </div>

                <div class="ear-visual-guard">
                    <button id="btn-listen" class="btn-listen">üéß Listen</button>
                    <p class="hint">Visuals hidden until you guess!</p>
                </div>

                <div id="ear-options" class="ear-options-grid">
                    <!-- Options injected by JS -->
                </div>

                <div id="ear-feedback" class="ear-feedback hidden">
                    <h3>Correct!</h3>
                    <p>That is a Perfect Fifth (3:2)</p>
                    <p id="ear-notes" style="font-size: 1rem; font-weight: bold; margin-bottom: 5px; color: #fff;"></p>
                    <p id="ear-explanation"
                        style="font-size: 0.95rem; opacity: 0.9; margin-bottom: 15px; font-style: italic; color: #a1e6cb;">
                    </p>
                    <button id="btn-next-question" class="btn-primary">Next Question arrow_forward</button>
                </div>
            </div>
        </div>
    </div>

    <script src="theory-engine.js"></script>
    <script src="app.js?v=110"></script>
</body>

</html>